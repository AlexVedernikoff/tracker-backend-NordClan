version: '3.3'
services:
  t2pg:
    hostname: track2-pg.docker
    image: postgres:9.6-alpine
    enviroment:
      POSTGRES_DB: simtrack
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./simtrack_db:/var/lib/postgresql/data
      - ./pg_db/dumps:/docker-entrypoint-initdb.d
      - ./pg_db:/pg

  t2back:
    image: {{ deploy_docker_registry_image }}
{% if deploy_app_volumes %}
    environment:
{% for item in deploy_app_envs %}
      - {{ item }}
{% endfor %}
{% endif %}
{% if deploy_app_docker_labels %}
      DATABASE_HOST: track2-test.docker.nordclan
      DATABASE_PORT: 33223
      DATABASE_NAME: track
      DATABASE_USERNAME: track
      DATABASE_PASSWORD: la4eeH2m
      API_ROOT: app
      API_PORT: 8080
    labels:
{% for item in deploy_app_docker_labels %}
      - {{ item }}
{% endfor %}
{% endif %}
    restart: unless-stopped
    command: "bash -c 'bash -s <<EOF npm install && npm rebuild && npm run migrate && pm2-runtime start --env development processes-debug.json EOF'"

networks:
  track2:
    external: true