version: '3.3'

services:
  t2back:
    image: {{ deploy_docker_registry_image }}
{% if deploy_app_volumes %}
    volumes:
{% for item in deploy_app_volumes %}
      - {{ item }}
{% endfor %}
{% endif %}
{% if deploy_app_envs %}
    environment:
{% for item in deploy_app_envs %}
      - {{ item }}
{% endfor %}
{% endif %}
{% if deploy_app_docker_labels %}
    labels:
{% for item in deploy_app_docker_labels %}
      - {{ item }}
{% endfor %}
{% endif %}
    restart: unless-stopped
    command: "bash -c 'bash -s <<EOF npm install && npm rebuild && npm run migrate && pm2-runtime start --env development processes-debug.json EOF'"
    ports:
      - 0.0.0.0:{{ deploy_app_port }}:3000
    networks:
      - {{ deploy_project_name }}-{{ deploy_env }}
    restart: unless-stopped

  t2pg:
    hostname: {{ deploy_project_name }}-pg.docker
    image: postgres:9.6-alpine
    volumes:
      - ./simtrack_db:/var/lib/postgresql/data
      - ./pg_db/dumps:/docker-entrypoint-initdb.d
      - ./pg_db:/pg
    networks:
      {{ deploy_project_name }}:
        ipv4_address: {{ service_net_subnet|replace(".0/24", ".3") }}
    ports:
      - 0.0.0.0:{{ docker_port_t2pg }}:5432

environment:
  - POSTGRES_DB=simtrack
  - POSTGRES_USER=postgres
  - POSTGRES_PASSWORD=postgres
  - DATABASE_HOST=track2-test.docker.nordclan
  - DATABASE_PORT=33223
  - DATABASE_NAME=track
  - DATABASE_USERNAME=track
  - DATABASE_PASSWORD=la4eeH2m
  - API_ROOT=app
  - API_PORT=8080

networks:
{{ deploy_project_name }}:
  external: true